<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sindi - Enviar Arquivos para Condom√≠nio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f8f9fa; min-height: 100vh; padding: 20px; }
        .container { max-width: 760px; margin: 0 auto; }
        .header { background: white; border-radius: 28px; padding: 36px 28px; margin-bottom: 24px;
                  box-shadow: 0 15px 45px rgba(0,0,0,0.08); text-align: center; border: 1px solid #eee; }
        .logo { width: 85px; height: 85px; border-radius: 50%; border: 5px solid #FF6B35;
                margin: 0 auto 18px; box-shadow: 0 6px 16px rgba(255,107,53,0.3); }
        h1 { font-size: 30px; color: #222; margin-bottom: 10px; font-weight: 700; }
        .subtitle { color: #666; font-size: 16.5px; line-height: 1.6; }

        .form-card { background: white; border-radius: 24px; padding: 36px 32px;
                     box-shadow: 0 12px 40px rgba(0,0,0,0.09); border: 1px solid #eee; }
        .form-group { margin-bottom: 28px; }
        .form-label { display: block; font-size: 15.5px; font-weight: 600; color: #333; margin-bottom: 10px; }
        .required { color: #FF6B35; }

        select, input[type="text"], textarea {
            width: 100%; padding: 16px 18px; border: 2px solid #e0e0e0;
            border-radius: 16px; font-size: 16px; background: white; transition: all 0.3s;
        }
        select:focus, input[type="text"]:focus, textarea:focus {
            outline: none; border-color: #FF6B35; box-shadow: 0 0 0 4px rgba(255,107,53,0.15);
        }
        textarea { min-height: 110px; resize: vertical; font-family: inherit; }

        input[type="file"] { padding: 16px 18px; border: 2px dashed #ccc; background: #fcfcfc; border-radius: 16px; cursor: pointer; }
        input[type="file"]::file-selector-button {
            padding: 12px 28px; background: linear-gradient(135deg, #FF6B35 0%, #ff8555 100%);
            color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;
        }

        .file-list { margin-top: 16px; padding: 18px; background: #f8f9fa; border-radius: 14px;
                     border: 1px dashed #bbb; max-height: 260px; overflow-y: auto; }
        .file-item { padding: 12px; background: white; border-radius: 10px; margin-bottom: 10px;
                     display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0; }
        .file-item:last-child { margin-bottom: 0; }
        .file-info { flex: 1; }
        .file-name { font-weight: 500; color: #333; margin-bottom: 4px; }
        .file-size { font-size: 13px; color: #666; }
        .file-size.error { color: #FF6B35; font-weight: 600; }
        .remove-file { background: #ff4444; color: white; border: none; width: 28px; height: 28px;
                       border-radius: 50%; cursor: pointer; font-size: 16px; display: flex;
                       align-items: center; justify-content: center; transition: all 0.2s;
                       flex-shrink: 0; margin-left: 12px; }
        .remove-file:hover { background: #cc0000; transform: scale(1.1); }

        .error-message { color: #FF6B35; font-size: 14px; margin-top: 8px; display: none; }
        .error-message.show { display: block; }

        .btn-submit { width: 100%; background: linear-gradient(135deg, #FF6B35 0%, #ff8555 100%);
                      color: white; border: none; padding: 18px; border-radius: 18px; font-size: 18px;
                      font-weight: 600; cursor: pointer; margin-top: 15px; box-shadow: 0 6px 18px rgba(255,107,53,0.35);
                      transition: all 0.3s; }
        .btn-submit:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(255,107,53,0.45); }
        .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .success-message, .error-alert, .loading { display: none; background: white; border-radius: 24px;
            padding: 50px 35px; box-shadow: 0 12px 40px rgba(0,0,0,0.09); text-align: center; margin-top: 30px; }
        .success-message.show, .error-alert.show, .loading.show { display: block; animation: slideDown 0.4s; }
        .file-success-list { background: #f8fff8; padding: 20px; border-radius: 14px; margin: 24px 0;
                             border: 1px solid #d4edda; max-height: 320px; overflow-y: auto; text-align: left; }
        .action-button { background: linear-gradient(135deg, #FF6B35 0%, #ff8555 100%);
                         color: white; padding: 16px 36px; border: none; border-radius: 16px;
                         font-size: 17px; font-weight: 600; cursor: pointer; margin-top: 20px; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #FF6B35; border-radius: 50%;
                   width: 70px; height: 70px; animation: spin 1s linear infinite; margin: 0 auto 25px; }
        .progress-text { color: #666; margin-top: 10px; font-size: 14px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img class="logo" src="https://salvatore.s3.us-east-2.amazonaws.com/sindi/SindiCIrcle.png" alt="Sindi">
            <h1>Enviar Arquivos para o Condom√≠nio</h1>
            <p class="subtitle">
                Fotos, v√≠deos, √°udios, PDFs, documentos Word/Excel/PowerPoint<br>
                <strong>M√°ximo 50 MB por arquivo</strong>
            </p>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Enviando arquivos...</p>
            <p class="progress-text" id="progressText">Isso pode levar at√© 2 minutos com arquivos grandes</p>
        </div>

        <div class="success-message" id="successMessage">
            <h2>‚úÖ Arquivos enviados com sucesso!</h2>
            <p>Tudo foi salvo com seguran√ßa.</p>
            <div class="file-success-list" id="successFileList"></div>
            <button class="action-button" onclick="resetForm()">Enviar Mais Arquivos</button>
        </div>

        <div class="error-alert" id="errorMessage">
            <h2>‚ö†Ô∏è Aviso</h2>
            <p id="errorText">Houve um problema. Tente novamente.</p>
            <button class="action-button" onclick="resetForm()">Tentar Novamente</button>
        </div>

        <div class="form-card" id="formContent">
            <form id="documentForm">
                <div class="form-group">
                    <label class="form-label" for="condominio">Condom√≠nio <span class="required">*</span></label>
                    <select id="condominio" required>
                        <option value="">Selecione o condom√≠nio</option>
                        <option value="Calton Hill">Calton Hill</option>
                        <option value="Parque dos Pr√≠ncipes">Parque dos Pr√≠ncipes</option>
                    </select>
                    <div class="error-message" id="condominioError">Campo obrigat√≥rio</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="categoria">Tipo de Arquivo <span class="required">*</span></label>
                    <select id="categoria" required>
                        <option value="">Escolha a categoria</option>
                        <option value="Reclama√ß√£o">Reclama√ß√£o / Den√∫ncia</option>
                        <option value="Sugest√£o">Sugest√£o</option>
                        <option value="Documento Oficial">Documento Oficial</option>
                        <option value="Foto de Problema">Foto de Problema</option>
                        <option value="V√≠deo">V√≠deo</option>
                        <option value="√Åudio">√Åudio</option>
                        <option value="Boleto">Boleto / Comprovante</option>
                        <option value="Outro">Outro</option>
                    </select>
                    <div class="error-message" id="categoriaError">Campo obrigat√≥rio</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="descricao">
                        Descri√ß√£o do(s) arquivo(s) <span class="required">*</span>
                        <br><small style="color:#666; font-weight:normal;">
                            Ex: Vazamento na garagem bloco B ‚Äì 15/03, Ata da assembleia 2024, V√≠deo barulho apartamento 502
                        </small>
                    </label>
                    <textarea id="descricao" placeholder="Descreva o conte√∫do dos arquivos de forma clara (ser√° usado para busca futura)" required></textarea>
                    <div class="error-message" id="descricaoError">A descri√ß√£o √© obrigat√≥ria</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="arquivos">
                        Arquivos <span class="required">*</span> (m√°x. 50 MB cada)
                    </label>
                    <input type="file" id="arquivos" multiple>
                    <div class="file-list" id="fileList">
                        <em>Clique para selecionar os arquivos</em>
                    </div>
                    <div class="error-message" id="arquivosError">Selecione pelo menos um arquivo</div>
                </div>

                <button type="submit" class="btn-submit" id="submitBtn">Enviar Arquivos</button>
            </form>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://n8n.polenta.chat/webhook-test/send-condo-sindicloud-s3';
        const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50 MB
        const TIMEOUT_MS = 120000; // 2 minutes

        const form = document.getElementById('documentForm');
        const fileInput = document.getElementById('arquivos');
        const fileList = document.getElementById('fileList');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const formContent = document.getElementById('formContent');
        const successFileList = document.getElementById('successFileList');
        const progressText = document.getElementById('progressText');

        let selectedFiles = new DataTransfer();

        fileInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files);
            newFiles.forEach(file => selectedFiles.items.add(file));
            updateFileList();
        });

        function updateFileList() {
            fileList.innerHTML = '';
            
            if (selectedFiles.files.length === 0) {
                fileList.innerHTML = '<em>Clique para selecionar os arquivos</em>';
                return;
            }

            Array.from(selectedFiles.files).forEach((file, index) => {
                const sizeMB = (file.size / 1024 / 1024).toFixed(1);
                const isTooBig = file.size > MAX_FILE_SIZE;
                
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size ${isTooBig ? 'error' : ''}">
                            ${isTooBig ? '‚ö†Ô∏è Tamanho excedido: ' : ''}${sizeMB} MB
                        </div>
                    </div>
                    <button type="button" class="remove-file" onclick="removeFile(${index})" title="Remover arquivo">√ó</button>
                `;
                fileList.appendChild(item);
            });
        }

        function removeFile(index) {
            const dt = new DataTransfer();
            Array.from(selectedFiles.files).forEach((file, i) => {
                if (i !== index) dt.items.add(file);
            });
            selectedFiles = dt;
            fileInput.files = selectedFiles.files;
            updateFileList();
        }

        form.addEventListener('submit', async e => {
            e.preventDefault();
            document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));

            const condominio = document.getElementById('condominio').value.trim();
            const categoria = document.getElementById('categoria').value.trim();
            const descricao = document.getElementById('descricao').value.trim();
            const files = selectedFiles.files;

            let erro = false;

            if (!condominio) { document.getElementById('condominioError').classList.add('show'); erro = true; }
            if (!categoria) { document.getElementById('categoriaError').classList.add('show'); erro = true; }
            if (!descricao) { document.getElementById('descricaoError').classList.add('show'); erro = true; }
            if (files.length === 0) { document.getElementById('arquivosError').classList.add('show'); erro = true; }

            for (let f of files) {
                if (f.size > MAX_FILE_SIZE) {
                    document.getElementById('arquivosError').textContent = `Arquivo muito grande: ${f.name}`;
                    document.getElementById('arquivosError').classList.add('show');
                    erro = true;
                }
            }

            if (erro) return;

            formContent.style.display = 'none';
            loading.classList.add('show');

            // Create abort controller for timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

            try {
                console.log('üöÄ Iniciando envio...');
                progressText.textContent = 'Preparando arquivos...';
                
                const arquivosArray = [];
                for (let file of files) {
                    console.log(`üìÑ Processando: ${file.name} (${(file.size/1024/1024).toFixed(1)} MB)`);
                    const base64 = await fileToBase64(file);
                    arquivosArray.push({
                        filename: file.name,
                        mimetype: file.type || 'application/octet-stream',
                        size: file.size,
                        data: base64.split(',')[1]
                    });
                }

                progressText.textContent = 'Enviando para o servidor...';

                const payload = {
                    condominio,
                    categoria,
                    descricao,
                    arquivos: arquivosArray,
                    timestamp: new Date().toISOString()
                };

                console.log('üì§ Enviando payload:', {
                    condominio,
                    categoria,
                    fileCount: arquivosArray.length,
                    totalSize: arquivosArray.reduce((sum, f) => sum + f.size, 0)
                });

                const res = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                console.log('üì• Resposta recebida:', res.status, res.statusText);

                // Handle 204 No Content (workflow executed but returned empty response)
                if (res.status === 204) {
                    console.warn('‚ö†Ô∏è Servidor retornou 204 - assumindo sucesso parcial');
                    loading.classList.remove('show');
                    successFileList.innerHTML = `
                        <p style="color:#666;">‚úÖ Os arquivos foram recebidos pelo servidor.</p>
                        <p style="color:#666; margin-top:10px;">
                            <strong>Arquivos enviados:</strong><br>
                            ${Array.from(files).map(f => `‚Ä¢ ${f.name} (${(f.size/1024/1024).toFixed(1)} MB)`).join('<br>')}
                        </p>
                        <p style="color:#ff8555; margin-top:15px; font-size:14px;">
                            ‚ÑπÔ∏è O servidor processou sua requisi√ß√£o mas n√£o retornou os links. 
                            Os arquivos devem estar salvos no sistema.
                        </p>
                    `;
                    successMessage.classList.add('show');
                    return;
                }

                if (!res.ok) {
                    throw new Error(`Erro do servidor: ${res.status} ${res.statusText}`);
                }

                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.warn('‚ö†Ô∏è Resposta n√£o √© JSON:', contentType);
                    throw new Error('Resposta inv√°lida do servidor (n√£o √© JSON)');
                }

                const result = await res.json();
                console.log('‚úÖ Resultado:', result);

                if (result.success !== false && (result.files || result.success)) {
                    loading.classList.remove('show');
                    successFileList.innerHTML = '';
                    
                    const filesArray = result.files || [];
                    if (filesArray.length > 0) {
                        filesArray.forEach(f => {
                            const div = document.createElement('div');
                            div.style.padding = '10px 0';
                            div.style.borderBottom = '1px solid #e0e0e0';
                            div.innerHTML = `
                                <strong>${f.filename}</strong> (${(f.size/1024/1024).toFixed(1)} MB)<br>
                                <a href="${f.url}" target="_blank" style="color:#FF6B35; text-decoration:none;">üîó Abrir / Baixar</a>
                            `;
                            successFileList.appendChild(div);
                        });
                    } else {
                        successFileList.innerHTML = '<p style="color:#666;">Arquivos enviados com sucesso!</p>';
                    }
                    
                    successMessage.classList.add('show');
                } else {
                    throw new Error(result.error || result.message || 'Erro desconhecido no servidor');
                }
            } catch (err) {
                clearTimeout(timeoutId);
                console.error('‚ùå Erro:', err);
                loading.classList.remove('show');
                
                let errorMsg = 'Falha na conex√£o com o servidor';
                if (err.name === 'AbortError') {
                    errorMsg = 'Tempo esgotado (2 minutos). Tente com arquivos menores ou menos arquivos de uma vez.';
                } else if (err.message) {
                    errorMsg = err.message;
                }
                
                document.getElementById('errorText').textContent = errorMsg;
                errorMessage.classList.add('show');
            }
        });

        function resetForm() {
            [loading, successMessage, errorMessage].forEach(el => el.classList.remove('show'));
            formContent.style.display = 'block';
            form.reset();
            selectedFiles = new DataTransfer();
            updateFileList();
            progressText.textContent = 'Isso pode levar at√© 2 minutos com arquivos grandes';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
