import React, { useState } from 'react';
import { Plus, TrendingUp, AlertTriangle, DollarSign, Calendar, CheckCircle, Edit2, Trash2 } from 'lucide-react';

export default function SindicoPlanner() {
  const [demands, setDemands] = useState([
    {
      id: 1,
      title: "Reparo elevador principal",
      cost: 8500,
      urgency: "alta",
      impact: "alta",
      legal: true,
      affected: 120,
      category: "Seguran√ßa",
      status: "pendente"
    },
    {
      id: 2,
      title: "Pintura fachada",
      cost: 45000,
      urgency: "baixa",
      impact: "m√©dia",
      legal: false,
      affected: 120,
      category: "Est√©tica",
      status: "pendente"
    },
    {
      id: 3,
      title: "Troca bomba piscina",
      cost: 3200,
      urgency: "m√©dia",
      impact: "baixa",
      legal: false,
      affected: 80,
      category: "Lazer",
      status: "pendente"
    },
    {
      id: 4,
      title: "Adequa√ß√£o hidrantes (bombeiros)",
      cost: 12000,
      urgency: "alta",
      impact: "alta",
      legal: true,
      affected: 120,
      category: "Seguran√ßa",
      status: "pendente"
    }
  ]);

  const [budget, setBudget] = useState(25000);
  const [showForm, setShowForm] = useState(false);
  const [newDemand, setNewDemand] = useState({
    title: "",
    cost: "",
    urgency: "m√©dia",
    impact: "m√©dia",
    legal: false,
    affected: "",
    category: "Manuten√ß√£o"
  });

  const calculatePriority = (demand) => {
    let score = 0;
    
    // Urg√™ncia
    if (demand.urgency === "alta") score += 40;
    else if (demand.urgency === "m√©dia") score += 20;
    else score += 5;
    
    // Impacto
    if (demand.impact === "alta") score += 30;
    else if (demand.impact === "m√©dia") score += 15;
    else score += 5;
    
    // Legal obrigat√≥rio
    if (demand.legal) score += 25;
    
    // N√∫mero de afetados (normalizado)
    score += (demand.affected / 120) * 5;
    
    return score;
  };

  const sortedDemands = [...demands]
    .filter(d => d.status === "pendente")
    .sort((a, b) => calculatePriority(b) - calculatePriority(a));

  const calculateScenario = () => {
    let remaining = budget;
    const executable = [];
    const waitlist = [];
    
    sortedDemands.forEach(demand => {
      if (remaining >= demand.cost) {
        executable.push(demand);
        remaining -= demand.cost;
      } else {
        waitlist.push(demand);
      }
    });
    
    return { executable, waitlist, remaining };
  };

  const scenario = calculateScenario();

  const addDemand = () => {
    if (!newDemand.title || !newDemand.cost) return;
    
    setDemands([...demands, {
      ...newDemand,
      id: Date.now(),
      cost: parseFloat(newDemand.cost),
      affected: parseInt(newDemand.affected) || 0,
      status: "pendente"
    }]);
    
    setNewDemand({
      title: "",
      cost: "",
      urgency: "m√©dia",
      impact: "m√©dia",
      legal: false,
      affected: "",
      category: "Manuten√ß√£o"
    });
    setShowForm(false);
  };

  const deleteDemand = (id) => {
    setDemands(demands.filter(d => d.id !== id));
  };

  const getUrgencyColor = (urgency) => {
    if (urgency === "alta") return "bg-red-100 text-red-800";
    if (urgency === "m√©dia") return "bg-yellow-100 text-yellow-800";
    return "bg-green-100 text-green-800";
  };

  const getPriorityBadge = (score) => {
    if (score >= 80) return <span className="text-red-600 font-bold">üî• Cr√≠tico</span>;
    if (score >= 60) return <span className="text-orange-600 font-semibold">‚ö†Ô∏è Alto</span>;
    if (score >= 40) return <span className="text-yellow-600">üìã M√©dio</span>;
    return <span className="text-gray-600">üìå Baixo</span>;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-3xl font-bold text-gray-800">Planejador Estrat√©gico</h1>
              <p className="text-gray-600">Decis√µes inteligentes para seu condom√≠nio</p>
            </div>
            <button
              onClick={() => setShowForm(!showForm)}
              className="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700 transition"
            >
              <Plus size={20} />
              Nova Demanda
            </button>
          </div>

          {/* Budget Control */}
          <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-200">
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üí∞ Or√ßamento Dispon√≠vel
            </label>
            <div className="flex items-center gap-4">
              <input
                type="number"
                value={budget}
                onChange={(e) => setBudget(parseFloat(e.target.value) || 0)}
                className="flex-1 px-4 py-2 border-2 border-green-300 rounded-lg text-xl font-bold text-gray-800 focus:ring-2 focus:ring-green-500 focus:border-transparent"
              />
              <span className="text-2xl font-bold text-green-700">R$</span>
            </div>
          </div>
        </div>

        {/* Form Nova Demanda */}
        {showForm && (
          <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 className="text-xl font-bold mb-4">Nova Demanda</h3>
            <div className="grid grid-cols-2 gap-4">
              <input
                type="text"
                placeholder="T√≠tulo da demanda"
                value={newDemand.title}
                onChange={(e) => setNewDemand({...newDemand, title: e.target.value})}
                className="col-span-2 px-4 py-2 border rounded-lg"
              />
              <input
                type="number"
                placeholder="Custo (R$)"
                value={newDemand.cost}
                onChange={(e) => setNewDemand({...newDemand, cost: e.target.value})}
                className="px-4 py-2 border rounded-lg"
              />
              <input
                type="number"
                placeholder="Moradores afetados"
                value={newDemand.affected}
                onChange={(e) => setNewDemand({...newDemand, affected: e.target.value})}
                className="px-4 py-2 border rounded-lg"
              />
              <select
                value={newDemand.urgency}
                onChange={(e) => setNewDemand({...newDemand, urgency: e.target.value})}
                className="px-4 py-2 border rounded-lg"
              >
                <option value="baixa">Urg√™ncia: Baixa</option>
                <option value="m√©dia">Urg√™ncia: M√©dia</option>
                <option value="alta">Urg√™ncia: Alta</option>
              </select>
              <select
                value={newDemand.impact}
                onChange={(e) => setNewDemand({...newDemand, impact: e.target.value})}
                className="px-4 py-2 border rounded-lg"
              >
                <option value="baixa">Impacto: Baixo</option>
                <option value="m√©dia">Impacto: M√©dio</option>
                <option value="alta">Impacto: Alto</option>
              </select>
              <select
                value={newDemand.category}
                onChange={(e) => setNewDemand({...newDemand, category: e.target.value})}
                className="px-4 py-2 border rounded-lg"
              >
                <option value="Seguran√ßa">Seguran√ßa</option>
                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                <option value="Est√©tica">Est√©tica</option>
                <option value="Lazer">Lazer</option>
              </select>
              <label className="flex items-center gap-2 px-4 py-2 border rounded-lg">
                <input
                  type="checkbox"
                  checked={newDemand.legal}
                  onChange={(e) => setNewDemand({...newDemand, legal: e.target.checked})}
                  className="w-5 h-5"
                />
                <span>Obriga√ß√£o legal</span>
              </label>
            </div>
            <div className="flex gap-2 mt-4">
              <button
                onClick={addDemand}
                className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700"
              >
                Adicionar
              </button>
              <button
                onClick={() => setShowForm(false)}
                className="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400"
              >
                Cancelar
              </button>
            </div>
          </div>
        )}

        {/* Scenario Analysis */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex items-center gap-3 mb-4">
              <CheckCircle className="text-green-600" size={28} />
              <div>
                <p className="text-sm text-gray-600">Execut√°vel Agora</p>
                <p className="text-2xl font-bold text-green-600">{scenario.executable.length}</p>
              </div>
            </div>
            <p className="text-sm text-gray-600">
              Total: <span className="font-bold">R$ {scenario.executable.reduce((acc, d) => acc + d.cost, 0).toLocaleString()}</span>
            </p>
          </div>

          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex items-center gap-3 mb-4">
              <Calendar className="text-orange-600" size={28} />
              <div>
                <p className="text-sm text-gray-600">Aguardando Or√ßamento</p>
                <p className="text-2xl font-bold text-orange-600">{scenario.waitlist.length}</p>
              </div>
            </div>
            <p className="text-sm text-gray-600">
              Faltam: <span className="font-bold">R$ {(scenario.waitlist.reduce((acc, d) => acc + d.cost, 0) - scenario.remaining).toLocaleString()}</span>
            </p>
          </div>

          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex items-center gap-3 mb-4">
              <DollarSign className="text-blue-600" size={28} />
              <div>
                <p className="text-sm text-gray-600">Saldo Remanescente</p>
                <p className="text-2xl font-bold text-blue-600">R$ {scenario.remaining.toLocaleString()}</p>
              </div>
            </div>
            <p className="text-sm text-gray-600">
              {scenario.remaining > 5000 ? "Reserva saud√°vel ‚úÖ" : scenario.remaining > 0 ? "Reserva justa ‚ö†Ô∏è" : "Sem reserva ‚ùå"}
            </p>
          </div>
        </div>

        {/* Priority Queue */}
        <div className="bg-white rounded-xl shadow-lg p-6">
          <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
            <TrendingUp className="text-indigo-600" />
            Fila de Prioriza√ß√£o Inteligente
          </h2>
          
          <div className="space-y-3">
            {sortedDemands.map((demand, index) => {
              const priority = calculatePriority(demand);
              const canExecute = scenario.executable.includes(demand);
              
              return (
                <div
                  key={demand.id}
                  className={`border-2 rounded-lg p-4 transition ${
                    canExecute ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-gray-50'
                  }`}
                >
                  <div className="flex items-start justify-between mb-2">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <span className="bg-indigo-600 text-white font-bold px-3 py-1 rounded-full text-sm">
                          #{index + 1}
                        </span>
                        <h3 className="font-bold text-lg text-gray-800">{demand.title}</h3>
                        {demand.legal && <AlertTriangle className="text-red-600" size={20} />}
                      </div>
                      
                      <div className="flex flex-wrap gap-2 mb-2">
                        <span className={`px-3 py-1 rounded-full text-xs font-semibold ${getUrgencyColor(demand.urgency)}`}>
                          {demand.urgency.charAt(0).toUpperCase() + demand.urgency.slice(1)}
                        </span>
                        <span className="px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                          {demand.category}
                        </span>
                        <span className="px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800">
                          {demand.affected} moradores
                        </span>
                      </div>
                    </div>
                    
                    <button
                      onClick={() => deleteDemand(demand.id)}
                      className="text-red-500 hover:text-red-700 p-2"
                    >
                      <Trash2 size={18} />
                    </button>
                  </div>
                  
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <span className="text-2xl font-bold text-gray-800">
                        R$ {demand.cost.toLocaleString()}
                      </span>
                      {getPriorityBadge(priority)}
                      <span className="text-sm text-gray-500">Score: {priority.toFixed(0)}</span>
                    </div>
                    
                    {canExecute ? (
                      <span className="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold">
                        ‚úì Executar Agora
                      </span>
                    ) : (
                      <span className="bg-orange-100 text-orange-800 px-4 py-2 rounded-lg font-semibold">
                        ‚è≥ Aguardar Or√ßamento
                      </span>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Insights */}
        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-lg p-6 mt-6 text-white">
          <h3 className="text-xl font-bold mb-3 flex items-center gap-2">
            üí° Insights Estrat√©gicos
          </h3>
          <ul className="space-y-2 text-sm">
            {scenario.executable.some(d => d.legal) && (
              <li>‚Ä¢ Priorize as obriga√ß√µes legais para evitar multas e problemas jur√≠dicos</li>
            )}
            {scenario.remaining < 5000 && (
              <li>‚Ä¢ Aten√ß√£o: Reserva de emerg√™ncia baixa. Considere adiar itens n√£o cr√≠ticos</li>
            )}
            {scenario.waitlist.length > scenario.executable.length && (
              <li>‚Ä¢ H√° mais demandas do que or√ßamento. Considere aumentar taxa condominial ou buscar parcelamento</li>
            )}
            {scenario.executable.length === sortedDemands.length && (
              <li>‚Ä¢ ‚úÖ Excelente! Or√ßamento suficiente para todas as demandas pendentes</li>
            )}
          </ul>
        </div>
      </div>
    </div>
  );
}
